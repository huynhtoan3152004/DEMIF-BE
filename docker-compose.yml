# ==============================================
# Docker Compose for Demif-BE
# Use this for local development or Coolify Docker Compose deployment
# ==============================================
#
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ğŸ“‹ COOLIFY ENVIRONMENT VARIABLES - Copy vÃ o "Environment Variables" tab     â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘                                                                              â•‘
# â•‘  # === DATABASE (PostgreSQL tá»« Coolify) ===                                  â•‘
# â•‘  ConnectionStrings__DefaultConnection=Host=<POSTGRES_HOST>;Port=5432;Database=demif_db;Username=demif;Password=<PASSWORD>;
# â•‘                                                                              â•‘
# â•‘  # === JWT CONFIGURATION ===                                                 â•‘
# â•‘  Jwt__Key=ThayDoiKeyNayItNhat32KyTuTroLenChoAnToan!                          â•‘
# â•‘  Jwt__Issuer=Demif.Api                                                       â•‘
# â•‘  Jwt__Audience=Demif.Client                                                  â•‘
# â•‘  Jwt__ExpirationMinutes=60                                                   â•‘
# â•‘                                                                              â•‘
# â•‘  # === ASP.NET CORE ===                                                      â•‘
# â•‘  ASPNETCORE_ENVIRONMENT=Production                                           â•‘
# â•‘                                                                              â•‘
# â•‘  # === FIREBASE (náº¿u cáº§n) ===                                                â•‘
# â•‘  # Firebase__project_id=your-project-id                                      â•‘
# â•‘  # Firebase__private_key=-----BEGIN PRIVATE KEY-----\n...\n-----END...      â•‘
# â•‘  # Firebase__client_email=firebase@your-project.iam.gserviceaccount.com      â•‘
# â•‘                                                                              â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  ğŸ’¡ HÆ¯á»šNG DáºªN:                                                               â•‘
# â•‘  1. Táº¡o PostgreSQL resource trÃªn Coolify                                     â•‘
# â•‘  2. Láº¥y Internal URL tá»« PostgreSQL settings â†’ paste vÃ o POSTGRES_HOST        â•‘
# â•‘  3. VÃ o tab "Environment Variables" cá»§a API resource                         â•‘
# â•‘  4. Paste cÃ¡c biáº¿n trÃªn (bá» dáº¥u # á»Ÿ Ä‘áº§u)                                     â•‘
# â•‘  5. Click Save â†’ Deploy                                                      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#

services:
  # Main API Service
  demif-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: demif-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=${DATABASE_URL}
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=${JWT_ISSUER:-Demif.Api}
      - Jwt__Audience=${JWT_AUDIENCE:-Demif.Client}
      - Jwt__ExpirationMinutes=${JWT_EXPIRATION_MINUTES:-60}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - demif-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: demif-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-demif}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-demif_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - demif-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-demif} -d ${POSTGRES_DB:-demif_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  demif-network:
    driver: bridge

volumes:
  postgres_data:
